<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinfoil API Tester</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --text-muted: #aaaaaa;
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --border-color: #444444;
            --input-bg: #222222;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
        }
        
        h1, h2, h3 {
            color: var(--text-color);
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input[type="text"], input[type="number"], select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--primary-hover);
        }
        
        button:disabled {
            background-color: #555555;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            background-color: var(--input-bg);
        }
        
        .file-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .file-item:hover {
            background-color: #3a3a3a;
        }
        
        .file-item.selected {
            background-color: #2c3e50;
        }
        
        .status-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #2c2c2c;
            border-left: 4px solid var(--primary-color);
        }
        
        .error {
            color: var(--error-color);
            border-left-color: var(--error-color);
        }
        
        .success {
            color: var(--success-color);
            border-left-color: var(--success-color);
        }
        
        .job-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #333333;
            border: 1px solid var(--border-color);
        }
        
        .job-progress {
            height: 8px;
            background-color: #444444;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .job-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            width: 0%;
        }
        
        .job-completed .job-progress-bar {
            background-color: var(--success-color);
        }
        
        .job-failed .job-progress-bar {
            background-color: var(--error-color);
        }
        
        .cog-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .cog-item {
            background-color: #3a3a3a;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        
        .cog-item.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #333333;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #666666;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }
    </style>
</head>
<body>
    <h1>Tinfoil API Tester</h1>
    
    <div class="card">
        <h2>API Configuration</h2>
        <div class="form-group">
            <label for="api-host">API Host</label>
            <input type="text" id="api-host" value="http://127.0.0.1" placeholder="API Host (e.g., http://127.0.0.1)">
        </div>
        <div class="form-group">
            <label for="api-port">API Port</label>
            <input type="number" id="api-port" value="8000" placeholder="API Port (e.g., 8000)">
        </div>
        <button id="test-connection">Test Connection</button>
    </div>
    
    <div class="container">
        <div>
            <div class="card">
                <h2>File Selection</h2>
                <input type="file" id="file-input" accept=".flac" style="display: none;" multiple>
                <button id="select-files">Select FLAC Files</button>
                <div id="selected-files" class="file-list" style="margin-top: 10px;">
                    <p>No files selected</p>
                </div>
            </div>
        </div>
        
        <div>
            <div class="card">
                <h2>Processing Options</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="force-update"> Force Update
                    </label>
                </div>
                <div class="form-group">
                    <label for="lyrics-source">Lyrics Source</label>
                    <select id="lyrics-source">
                        <option value="genius">Genius</option>
                        <option value="lrclib">LRCLIB</option>
                        <option value="netease">NetEase</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="output-pattern">Output Pattern (optional)</label>
                    <input type="text" id="output-pattern" placeholder="{artist}/{year} - {album}/{track:02d} - {title}">
                </div>
                <div class="form-group">
                    <label>Cogs</label>
                    <div id="cog-list" class="cog-list">
                        <p>Loading available cogs...</p>
                    </div>
                </div>
                <button id="process-files" disabled>Process Files</button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>Jobs</h2>
        <div id="jobs-container"></div>
    </div>
    
    <div id="status-area" class="status-area" style="display: none;"></div>
    
    <script>
        // Store API base URL
        let apiBaseUrl = '';
        
        // Store available cogs
        let availableCogs = [];
        let selectedCogs = [];
        
        // Store active jobs
        let activeJobs = {};
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Set up API URL from defaults
            updateApiBaseUrl();
            
            // Set up event listeners
            document.getElementById('test-connection').addEventListener('click', testConnection);
            document.getElementById('select-files').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', handleFileSelection);
            document.getElementById('process-files').addEventListener('click', processFiles);
            
            // Set up API URL update when inputs change
            document.getElementById('api-host').addEventListener('change', updateApiBaseUrl);
            document.getElementById('api-port').addEventListener('change', updateApiBaseUrl);
        });
        
        // Update the API base URL
        function updateApiBaseUrl() {
            const host = document.getElementById('api-host').value.trim();
            const port = document.getElementById('api-port').value.trim();
            apiBaseUrl = `${host}:${port}`;
            console.log(`API base URL set to ${apiBaseUrl}`);
        }
        
        // Test the API connection
        async function testConnection() {
            showStatus('Testing connection to API...', 'info');
            try {
                const response = await fetch(`${apiBaseUrl}/config`);
                if (response.ok) {
                    const config = await response.json();
                    showStatus(`Connection successful! API version: ${config.version}`, 'success');
                    
                    // Load available cogs
                    loadCogs();
                    
                    // Enable the process button
                    document.getElementById('process-files').disabled = false;
                } else {
                    throw new Error(`API returned status: ${response.status}`);
                }
            } catch (error) {
                showStatus(`Connection failed: ${error.message}`, 'error');
            }
        }
        
        // Load available cogs from the API
        async function loadCogs() {
            try {
                const response = await fetch(`${apiBaseUrl}/cogs`);
                if (response.ok) {
                    availableCogs = await response.json();
                    renderCogList();
                } else {
                    throw new Error(`API returned status: ${response.status}`);
                }
            } catch (error) {
                showStatus(`Failed to load cogs: ${error.message}`, 'error');
            }
        }
        
        // Render the list of available cogs
        function renderCogList() {
            const cogListContainer = document.getElementById('cog-list');
            cogListContainer.innerHTML = '';
            
            availableCogs.forEach(cog => {
                const cogItem = document.createElement('div');
                cogItem.className = 'cog-item';
                cogItem.textContent = cog.name;
                cogItem.title = `Inputs: ${cog.input_tags.join(', ')}\nOutputs: ${cog.output_tags.join(', ')}`;
                cogItem.dataset.cogName = cog.name;
                
                cogItem.addEventListener('click', () => {
                    cogItem.classList.toggle('selected');
                    if (cogItem.classList.contains('selected')) {
                        selectedCogs.push(cog.name);
                    } else {
                        selectedCogs = selectedCogs.filter(name => name !== cog.name);
                    }
                    console.log('Selected cogs:', selectedCogs);
                });
                
                cogListContainer.appendChild(cogItem);
            });
        }
        
        // Handle file selection
        function handleFileSelection(event) {
            const files = event.target.files;
            const selectedFilesContainer = document.getElementById('selected-files');
            
            if (files.length === 0) {
                selectedFilesContainer.innerHTML = '<p>No files selected</p>';
                return;
            }
            
            selectedFilesContainer.innerHTML = '';
            for (const file of files) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.textContent = file.name;
                selectedFilesContainer.appendChild(fileItem);
            }
            
            // Enable process button if files are selected
            document.getElementById('process-files').disabled = false;
        }
        
        // Process selected files
        async function processFiles() {
            const fileInput = document.getElementById('file-input');
            if (fileInput.files.length === 0) {
                showStatus('Please select at least one file', 'error');
                return;
            }
            
            // Get processing options
            const forceUpdate = document.getElementById('force-update').checked;
            const lyricsSource = document.getElementById('lyrics-source').value;
            const outputPattern = document.getElementById('output-pattern').value;
            
            // Process each file
            for (const file of fileInput.files) {
                await processFile(file, forceUpdate, lyricsSource, outputPattern);
            }
        }
        
        // Process a single file
        async function processFile(file, forceUpdate, lyricsSource, outputPattern) {
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('force_update', forceUpdate);
                formData.append('lyrics_source', lyricsSource);
                
                if (outputPattern) {
                    formData.append('output_pattern', outputPattern);
                }
                
                if (selectedCogs.length > 0) {
                    formData.append('selected_cogs', selectedCogs.join(','));
                }
                
                // Send to API
                const response = await fetch(`${apiBaseUrl}/process`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                
                const jobData = await response.json();
                const jobId = jobData.job_id;
                
                // Show in jobs list
                addJob(jobId, file.name);
                
                // Start polling for job status
                pollJobStatus(jobId);
                
                showStatus(`Processing started for ${file.name} (Job ID: ${jobId})`, 'info');
            } catch (error) {
                showStatus(`Failed to process file ${file.name}: ${error.message}`, 'error');
            }
        }
        
        // Add a job to the UI
        function addJob(jobId, fileName) {
            const jobsContainer = document.getElementById('jobs-container');
            
            const jobItem = document.createElement('div');
            jobItem.className = 'job-item';
            jobItem.id = `job-${jobId}`;
            
            jobItem.innerHTML = `
                <div>
                    <strong>${fileName}</strong>
                    <span class="job-status">Status: Pending</span>
                </div>
                <div class="job-progress">
                    <div class="job-progress-bar" style="width: 0%"></div>
                </div>
                <div class="job-result"></div>
            `;
            
            jobsContainer.appendChild(jobItem);
            
            // Store job info
            activeJobs[jobId] = {
                fileName,
                status: 'pending',
                progress: 0,
                element: jobItem
            };
        }
        
        // Poll for job status
        async function pollJobStatus(jobId) {
            if (!activeJobs[jobId]) return;
            
            try {
                const response = await fetch(`${apiBaseUrl}/status/${jobId}`);
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                
                const jobStatus = await response.json();
                updateJobUI(jobId, jobStatus);
                
                // Continue polling if job is not completed or failed
                if (jobStatus.status === 'pending' || jobStatus.status === 'processing') {
                    setTimeout(() => pollJobStatus(jobId), 2000);
                }
            } catch (error) {
                console.error(`Error polling job ${jobId}:`, error);
                updateJobUI(jobId, { 
                    status: 'failed', 
                    error: `Polling error: ${error.message}`
                });
            }
        }
        
        // Update job UI with status information
        function updateJobUI(jobId, jobStatus) {
            const job = activeJobs[jobId];
            if (!job) return;
            
            job.status = jobStatus.status;
            job.progress = jobStatus.progress * 100;
            
            const jobElement = job.element;
            const statusElement = jobElement.querySelector('.job-status');
            const progressBarElement = jobElement.querySelector('.job-progress-bar');
            const resultElement = jobElement.querySelector('.job-result');
            
            statusElement.textContent = `Status: ${jobStatus.status}`;
            progressBarElement.style.width = `${job.progress}%`;
            
            // Remove existing classes
            jobElement.classList.remove('job-pending', 'job-processing', 'job-completed', 'job-failed');
            
            // Add appropriate class based on status
            jobElement.classList.add(`job-${jobStatus.status}`);
            
            // Update result based on job status
            if (jobStatus.status === 'completed') {
                const result = jobStatus.result;
                if (result) {
                    resultElement.innerHTML = `
                        <div style="margin-top: 10px;">
                            <strong>Success:</strong> ${result.success}<br>
                            <strong>Output:</strong> ${result.output_path}<br>
                        </div>
                    `;
                }
            } else if (jobStatus.status === 'failed') {
                resultElement.innerHTML = `
                    <div style="margin-top: 10px; color: var(--error-color);">
                        <strong>Error:</strong> ${jobStatus.error || 'Unknown error'}
                    </div>
                `;
            }
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('status-area');
            statusArea.textContent = message;
            statusArea.style.display = 'block';
            
            // Remove existing classes
            statusArea.classList.remove('error', 'success', 'info');
            
            // Add class based on type
            statusArea.classList.add(type);
            
            // Auto hide after 10 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusArea.style.display = 'none';
                }, 10000);
            }
        }
    </script>
</body>
</html>